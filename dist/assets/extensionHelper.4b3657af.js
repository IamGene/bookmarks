import"./modulepreload-polyfill.b7f2da20.js";console.log("\u2705 Extension Helper \u52A0\u8F7D\u6210\u529F");async function l(o,e){const a=await e.getAllFromIndex("nodes","pageId",o);a.sort((r,t)=>{var s,c;return((s=r.order)!=null?s:0)-((c=t.order)!=null?c:0)});function n(r){return a.filter(t=>t.pId===r).map(t=>{if(t.type==="folder"){const s=n(t.id);return{...t,status:1,children:s}}else return t})}return n(null)}async function i(){return await idb.openDB("BookmarksDB",1,{upgrade(o){if(o.objectStoreNames.contains("pages")||o.createObjectStore("pages",{keyPath:"pageId"}),!o.objectStoreNames.contains("nodes")){const e=o.createObjectStore("nodes",{keyPath:"id"});e.createIndex("pageId","pageId"),e.createIndex("pId","pId")}if(!o.objectStoreNames.contains("urls")){const e=o.createObjectStore("urls",{keyPath:"id"});e.createIndex("pageId","pageId"),e.createIndex("gId","gId")}}})}async function d(){const o=await i(),n=await o.transaction("pages","readonly").objectStore("pages").getAll();if(console.log("!!!!!!!! getCollectPageGroups pages",n,n.length),n.length>0){const r=n.find(c=>c.default===!0),t=r?r.pageId:n[0].pageId,s=await l(t,o);return console.log("RRRRRRRRR res",s),s}else return[{id:uuid(),name:"\u9ED8\u8BA4\u5206\u7EC40",type:"folder",status:0,children:[]}]}const g=o=>{console.log("PING \u6536\u5230\uFF0C\u56DE\u590D PONG"),window.parent.postMessage({type:"PONG"},"*")},p=async o=>{console.log("\u5F00\u59CB\u83B7\u53D6\u5206\u7EC4\u6570\u636E...");try{const e=await d();console.log("helper \u5DF2\u8FD4\u56DE\u5206\u7EC4\u6570\u636E",e),window.parent.postMessage({type:"GROUPS_RESPONSE",payload:e},"*")}catch(e){console.error("\u83B7\u53D6\u5206\u7EC4\u5931\u8D25:",e),window.parent.postMessage({type:"GROUPS_RESPONSE",payload:[]},"*")}},u=async(o,e)=>{console.log("\u51C6\u5907\u4FDD\u5B58\u4E66\u7B7E:",e);try{const a=saveBookmarkToDB(e);window.parent.postMessage({type:"SAVE_RESULT",payload:{ok:!0}},"*")}catch(a){console.error("\u4FDD\u5B58\u4E66\u7B7E\u5931\u8D25:",a),window.parent.postMessage({type:"SAVE_RESULT",payload:{ok:!1,error:a.message}},"*")}};window.addEventListener("message",async o=>{console.log("\u6536\u5230\u6D88\u606F11:",o.data),console.log("event.origin",o.origin),console.log("window.location.origin",window.location.origin);const{type:e,payload:a}=o.data||{};switch(console.log("\u6D88\u606F type:",e),e){case"PING":g();break;case"LIST_GROUPS":await p();break;case"SAVE_BOOKMARK":await u(o,a);break;default:console.warn("\u672A\u77E5\u6D88\u606F\u7C7B\u578B:",e)}});
