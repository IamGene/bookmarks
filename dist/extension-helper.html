<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>Extension Helper</title>
</head>

<body>
  <div>Extension Helper Page</div>
  <!-- <script type="module" src="../src/extension/extension-helper1.ts"></script> -->
  <script type="text/javascript" src="./idb.umd.js"></script>
  <script type="module">
    // import { getCollectPageGroups, saveBookmarkToDB } from '@/db/bookmarksPages';

    console.log("✅ Extension Helper 加载成功");

    async function getPageNodesTree(pageId, db) {
      const nodes = await db.getAllFromIndex('nodes', 'pageId', pageId);
      nodes.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
      function buildTree(parentId) {
        return nodes
          .filter(node => node.pId === parentId)
          .map(node => {
            if (node.type === 'folder') {
              const children = buildTree(node.id);
              return {
                ...node,
                status: 1,
                children: children,
                // urlList: urlList,
              };
            } else {
              return node;
            }
          });
      }
      return buildTree(null); // 根节点
    }

    async function getDB() {
      // ✅ 第一步：确保持久化检测（仅执行一次，不影响性能）
      // await ensurePersistenceOnce();
      // ✅ 第二步：打开数据库
      return await idb.openDB('BookmarksDB', 1, {
        upgrade(db) {
          if (!db.objectStoreNames.contains('pages')) {
            db.createObjectStore('pages', { keyPath: 'pageId' });
          }
          if (!db.objectStoreNames.contains('nodes')) {
            // const store = db.createObjectStore('nodes', { keyPath: 'id', autoIncrement: true });
            const store = db.createObjectStore('nodes', { keyPath: 'id' });
            store.createIndex('pageId', 'pageId');
            store.createIndex('pId', 'pId');
          }
          if (!db.objectStoreNames.contains('urls')) {
            const store = db.createObjectStore('urls', { keyPath: 'id' });
            store.createIndex('pageId', 'pageId');
            store.createIndex('gId', 'gId');
          }
        }
      });
    }

    async function getCollectPageGroups() {
      const db = await getDB();
      const tx = db.transaction('pages', 'readonly');
      const store = tx.objectStore('pages');
      const pages = await store.getAll();
      console.log('!!!!!!!! getCollectPageGroups pages', pages, pages.length);
      if (pages.length > 0) {//只有用户存在标签数据才能查询
        const defaultPage = pages.find(page => page.default === true);
        const pageId = defaultPage ? defaultPage.pageId : pages[0].pageId; //选择默认或者第一个书签页
        const res = await getPageNodesTree(pageId, db);
        console.log('RRRRRRRRR res', res)
        return res;
      } else {
        // 返回一个与 getPageNodesTree 结构一致的默认分组
        return [
          {
            id: uuid(),
            name: "默认分组0",
            type: 'folder',
            status: 0,
            children: [],
            // urlList: [],
          }];
      }

    }

    /** 心跳检测 */
    const handlePing = (event) => {
      console.log('PING 收到，回复 PONG');
      window.parent.postMessage({ type: 'PONG' }, '*');
    };

    /** 获取分组列表 */
    const handleListGroups = async (event) => {
      console.log('开始获取分组数据...');
      try {
        const groups = await getCollectPageGroups();
        console.log('helper 已返回分组数据', groups);
        window.parent.postMessage({ type: 'GROUPS_RESPONSE', payload: groups }, '*');
      } catch (err) {
        console.error('获取分组失败:', err);
        window.parent.postMessage({ type: 'GROUPS_RESPONSE', payload: [] }, '*');
      }
    };

    /** 保存书签 */
    const handleSaveBookmark = async (event, payload) => {
      console.log('准备保存书签:', payload);
      try {
        // TODO: 这里可以调用 saveBookmarkToDB(payload)

        // console.log("收到保存请求11111：", payload);
        const res = saveBookmarkToDB(payload);
        // const data = { title, url, icon, groupId, status };
        // console.log('书签保存成功（模拟）2');
        window.parent.postMessage({ type: 'SAVE_RESULT', payload: { ok: true } }, '*');
      } catch (err) {
        console.error('保存书签失败:', err);
        window.parent.postMessage({ type: 'SAVE_RESULT', payload: { ok: false, error: err.message } }, '*');
      }
    };

    // helper 监听来自扩展的消息
    window.addEventListener("message", async (event) => {

      // 调试信息：收到消息时打印消息内容
      console.log("收到消息11:", event.data);
      console.log("event.origin", event.origin);
      console.log("window.location.origin", window.location.origin);

      // 我们只关心来自我们自己的窗口或可信来源的消息
      // 在生产环境中，您应该将 event.origin 与您的插件ID进行严格比较
      // 例如: if (event.origin !== 'chrome-extension://your-extension-id') return;
      /* if (event.source !== window || !event.data || !event.data.type) {
          return;
      } */
      // 安全校验：同源消息
      // if (event.origin !== window.location.origin) return;

      const { type, payload } = event.data || {};
      console.log('消息 type:', type);

      switch (type) {
        case 'PING':
          handlePing(event);
          break;
        case 'LIST_GROUPS':
          await handleListGroups(event);
          break;
        case 'SAVE_BOOKMARK':
          await handleSaveBookmark(event, payload);
          break;
        default:
          console.warn('未知消息类型:', type);
      }

      // const { type, payload } = event.data;
      // console.log("消息:type", type); // 调试用

      // 响应 "心跳检测"，用于确认 helper 页面已准备就绪
      /* if (type === "PING") {
          window.postMessage({ type: "PONG" }, event.origin);
      }
  
      // 当接收到来自 content.js 的 LIST_GROUPS 消息时
      if (type === "LIST_GROUPS") {
          // ✅ 调用函数从 IndexedDB 获取真实的分组数据
          const groups = await getCollectPageGroups();
  
          // 调试信息：在控制台打印获取到的分组数据
          console.log("从数据库获取的分组数据:", groups);
          // 将分组数据发送回 content.js
          window.parent.postMessage({ type: 'GROUPS_RESPONSE', payload: groups }, '*');
      }
  
      // 当收到保存书签的请求时
      if (type === "SAVE_BOOKMARK") {
          // 从消息负载中提取书签信息
          const { title, url, icon, groupId, status } = payload;
  
          // ✅ 暂时打印，下一步可以换成调用真正的数据库写入函数
          console.log("收到保存请求：", { title, url, icon, groupId, status });
  
          // 告诉请求方保存成功 (这里可以根据实际保存结果返回成功或失败)
          window.postMessage({ type: "SAVE_RESULT", payload: { ok: true } }, event.origin);
      } */
    });
  </script>
</body>

</html>